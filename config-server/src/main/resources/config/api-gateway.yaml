server:
  port: 8000

spring:
  application:
    name: api-gateway

  cloud:
    vault:
      uri: http://localhost:8200
      authentication: APPROLE
      app-role:
        role-id: ${VAULT_API_GATEWAY_ROLE_ID:}
        secret-id: ${VAULT_API_GATEWAY_SECRET_ID:}
      fail-fast: true
      config.lifecycle.enabled: true

    gateway:
    # CORS for browser apps hitting the gateawu
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPattern:
              - "http://localhost"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - PATCH
              - OPTIONS
              - HEAD
            allowedHeaders: "*"
            exposedHeaders: "page-total-count"
            allowCredentials: true

      # service discovery; lb://<service-id>
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true

      routes:
        # refresh token endpoint, rate-limited by IP
        - id: auth-public
          uri: lb://user-service
          predicates:
            - Path=/api/v1/auth/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                # how many tokens replenish per second
                redis-rate-limiter.replenishRate: 5
                # max bucket size; allows short bursts up to this capcacity
                redis-rate-limiter.burstCapacity: 10
                # ipKeyResoler for this route
                key-resolver: "#{@ipKeyResolver}"

        - id: password-policies-public
          uri: lb://password-service
          predicates:
            - Path=/api/v1/password/policies
          filters:
            - StripPrefix=2

        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/v1/users/**
          filters:
            - StripPrefix=2
            - name: Auth

        - id: instance-public
          uri: lb://instance-service
          predicates:
            - Path=/api/v1/instances/**
          filters:
            - StripPrefix=2

        - id: password-service
          uri: lb://password-service
          predicates:
            - Path=/api/v1/password/**
          filters:
            - StripPrefix=2
            - name: Auth
            # - name: DeviceAuth

        - id: task-service
          uri: lb://task-service
          predicates:
            - Path=/api/v1/task/**
          filters:
            - StripPrefix=2

        # Swagger/OpenAPI doc rewrites
        - id: user-service-doc
          uri: lb://user-service
          predicates:
            - Path=/user-service/v3/api-docs
          filters:
            - RewritePath=/user-service/(?<segment>.*), /$\{segment}
        - id: password-service-doc
          uri: lb://password-service
          predicates:
            - Path=/password-service/v3/api-docs
          filters:
            - RewritePath=/password-service/(?<segment>.*), /$\{segment}
        - id: task-service-doc
          uri: lb://task-service
          predicates:
            - Path=/task-service/v3/api-docs
          filters:
            - RewritePath=/task-service/(?<segment>.*), /$\{segment}
        # - id: retry
        #   uri: lb://user-service
        #   predicates:
        #     - Path=/ui/v1/auth/registration/**
        #   filters:
        #     - name: Retry
        #       args:
        #         retries: 5
        #         statuses: REQUEST_TIMEOUT, SERVICE_UNAVAILABLE
        #         methods: POST
        #         backoff:
        #           firstBackoff: 10ms
        #           maxBackoff: 50ms
        #           factor: 3
        #           basedOnPreviousValue: false
  redis:
    host: ${REDIS_HOST:localhost}
    port: 6379

security:
  frontend-api-key: ${SECRET_FETCH_KEY}

management:
  endpoint:
    # shutdown:
    #   enabled: true
    gateway:
      enabled: true
  endpoints:
    web:
      exposure:
        include: "*"
  zipkin:
    tracing:
      endpoint: http://${ZIPKIN_HOST:localhost}:9411/api/v2/spans
  tracing:
    sampling:
      probability: 1.0

eureka:
  client:
    service-url:
      defaultZone: http://${EUREKA_HOST:localhost}:8761/eureka
    fetch-registry: true
    register-with-eureka: true
  instance:
    hostname: ${HOST_NAME:localhost}
springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    config-url: /v3/api-docs/swagger-config
    urls:
      - url: /v3/api-docs
        name: API Gateway Service
      - url: /user-service/v3/api-docs
        name: User Service
      - url: /password-service/v3/api-docs
        name: Password Service
      - url: /task-service/v3/api-docs
        name: Task Service